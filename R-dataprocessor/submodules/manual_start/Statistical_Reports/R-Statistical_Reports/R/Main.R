#' Create Statistical Report for INTERPOLAR Ward Metrics
#'
#' Generates a comprehensive statistical report for patients hospitalized on INTERPOLAR wards,
#' using patient, encounter, and front-end documentation data within a defined reporting period.
#' The report computes base population metrics (F1) and a summary of medication safety documentation
#' for internal monitoring and evaluation. REPORT_PERIOD_START and REPORT_PERIOD_END can be set
#' via command line arguments. Defaults are set to `"2025-01-01"` for the start date and the
#' current date for the end date.
#'
#' @param REPORT_PERIOD_START Character string in `"YYYY-MM-DD"` format.
#'   Start date of the reporting period.
#' @param REPORT_PERIOD_END Character string in `"YYYY-MM-DD"` format.
#'   End date of the reporting period. Defaults to `Sys.Date()`.
#'
#' @return Invisibly returns `NULL`. This function is called for its side effects:
#' writing local and global summary tables and producing a structured internal report.
#'
#' @details
#' The function performs the following main steps:
#'
#' \enumerate{
#'   \item Fetches source tables:
#'     \itemize{
#'       \item `getPatientData()` – one row per patient
#'       \item `getEncounterData()` – multiple rows per encounter possible
#'       \item `getPidsPerWardData()` – ward stays per sub-encounter
#'       \item `getPatientFeData()` – one row per patient
#'       \item `getFallFeData()` – one or more rows per case
#'       \item `getMedikationsanalyseFeData()` – latest version per entry
#'       \item `getMRPDokumentationValidierungFeData()` – latest version per entry
#'     }
#'
#'   \item Constructs the core encounter-patient dataset:
#'     \itemize{
#'       \item `mergePatEnc()`, `addCuratedEncPeriodEnd()`, `addMainEncId()`, `addMainEncPeriodStart()`,
#'       \item `calculateAge()`, `addWardName()`, `addRecordId()`, `addFallIdAndStudienphase()`
#'     }
#'
#'   \item Merges and enriches front-end documentation:
#'     \itemize{
#'       \item `mergePatFeFallFe()`, `addMedaData()`, `addEncIdToFeData()`, `addMRPDokuData()`
#'     }
#'
#'   \item Defines the Full Analysis Set 1 (FAS1) base population with `defineFullAnalysisSet1()`
#'
#'   \item Prepares and calculates key F1 metrics:
#'     \itemize{
#'       \item `prepareF1data()`, `addFeDataToF1data()`, `calculateF1()`, `calculateFeAddOnToF1()`
#'     }
#'
#'   \item Summarizes medication and MRP documentation activity:
#'     \itemize{
#'       \item `prepareFeSummaryData()`, `calculateFeSummary()`
#'     }
#'
#'   \item Writes outputs:
#'     \itemize{
#'       \item `writeTableLocal()` – intermediate data for verification
#'       \item `writeTableGlobal()` – final reports with captions and footnotes
#'     }
#' }
#'
#' @section Output:
#' - **Local output**: `FHIR_table`, `full_analysis_set_1`, `statistical_report_data`, `frontend_table`, `frontend_summary_data`
#' - **Global output**:
#'   \itemize{
#'     \item `statistical_report`: F1 metrics with front-end add-ons
#'     \item `frontend_summary`: Overall summary of front-end documentation
#'   }
#' Tables include captions describing the reporting period and footnotes explaining relevant metric assumptions.
#'
#' @note
#' Additional functionality for F2 metrics is scaffolded in the function but currently inactive.
#' Future versions may support Quarto or PDF report rendering.
#'
#' @seealso
#' [getPatientData()], [getEncounterData()], [getPidsPerWardData()],
#' [mergePatEnc()], [defineFullAnalysisSet1()], [prepareF1data()], [calculateF1()],
#' [prepareFeSummaryData()], [calculateFeSummary()],
#' [writeTableLocal()], [writeTableGlobal()]
#'
#' @export
createStatisticalReport <- function(REPORT_PERIOD_START ="2025-01-01",
                                    REPORT_PERIOD_END = as.character(Sys.Date())) {

  if (!interactive()) {
    named_args <- parse_named_args()
    if ("REPORT_PERIOD_START" %in% names(named_args)) {
      REPORT_PERIOD_START <- named_args[["REPORT_PERIOD_START"]]
    }
    if ("REPORT_PERIOD_END" %in% names(named_args)) {
      REPORT_PERIOD_END <- named_args[["REPORT_PERIOD_END"]]
    }
  }

  print(paste0("Report period start: ", REPORT_PERIOD_START,
               ", Report period end: ", REPORT_PERIOD_END))

  patient_table <- getPatientData(lock_id = "statistical reports[1]",
                                    table_name = "v_patient_last_version")
  # --> this table should only have one entry per patient (error if not)

  encounter_table <- getEncounterData(lock_id = "statistical reports[2]",
                                        table_name = "v_encounter_last_version")
  # this table can have multiple rows per encounter
  # e.g. if there are entries for enc_location_physicaltype_code wa, ro & bd

  pids_per_ward_table <- getPidsPerWardData(lock_id = "statistical reports[3]",
                                                table_name = "v_pids_per_ward")
  # this table can have multiple entries per main encounter due to transferral to another ward,
  # it should include the encounter level "Versorgungsstellenkontakt"

  # TODO: check if the appropriate views are used -------
  patient_fe_table <- getPatientFeData(lock_id = "statistical reports[4]",
                                  table_name = "v_patient_fe")
  # --> this table should only have one entry per patient (error if not)

  fall_fe_table <- getFallFeData(lock_id = "statistical reports[5]",
                                  table_name = "v_fall_fe")
  # --> this table shows the trajectory of each case in the front-end system (multiple rows per case possible)

  medikationsanalyse_fe_table <- getMedikationsanalyseFeData(lock_id = "statistical reports[6]",
                                  table_name = "v_medikationsanalyse_fe_last_import")
  # --> this table shows only the last version of each medikationsanalyse_fe entry

  mrp_dokumentation_validierung_fe_table <- getMRPDokumentationValidierungFeData(lock_id = "statistical reports[7]",
                                  table_name = "v_mrpdokumentation_validierung_fe_last_import")
  # --> this table shows only the last version of each mrp_dokumentation_validierung_fe entry

  FHIR_table <- mergePatEnc(patient_table, encounter_table) |>
    addCuratedEncPeriodEnd() |>
    addMainEncId() |>
    addMainEncPeriodStart() |>
    calculateAge() |>
    addWardName(pids_per_ward_table) |>
    addRecordId(patient_fe_table) |>
    addFallIdAndStudienphase(fall_fe_table)

  full_analysis_set_1 <- defineFullAnalysisSet1(FHIR_table)

  frontend_table <-mergePatFeFallFe(patient_fe_table, fall_fe_table) |>
    addMedaData(medikationsanalyse_fe_table) |>
    addEncIdToFeData(full_analysis_set_1) |>
    addMRPDokuData(mrp_dokumentation_validierung_fe_table)

  frontend_summary_data <- prepareFeSummaryData(frontend_table, REPORT_PERIOD_START, REPORT_PERIOD_END)

  statistical_report_data <- prepareF1data(full_analysis_set_1, REPORT_PERIOD_START, REPORT_PERIOD_END) |>
    addFeDataToF1data(frontend_summary_data)

  # FAS2_1 <- defineFAS2_1(full_analysis_set_1, REPORT_PERIOD_END)
  # F2_data <- prepareF2data(FAS2_1, REPORT_PERIOD_START, REPORT_PERIOD_END)

  # Print datasets for verification to outputLocal
  writeTableLocal(FHIR_table)
  writeTableLocal(full_analysis_set_1)
  writeTableLocal(statistical_report_data)
  writeTableLocal(frontend_table)
  writeTableLocal(frontend_summary_data)

  frontend_summary <- calculateFeSummary(frontend_summary_data)

  statistical_report <- calculateF1(statistical_report_data) |>
    calculateFeAddOnToF1(statistical_report_data)
  # calculateF2(F2_data)


  # print report to outputGlobal
  writeTableGlobal(statistical_report,
             caption = paste0("report for period: ",REPORT_PERIOD_START, " to ", REPORT_PERIOD_END),
             footnote = c("F1: Cumulative number of hospitalized cases on INTERPOLAR wards (>18y, initial INTERPOLAR ward contact)",
                          "Medication analysis and mrp counts: only for first medication analysis of initial INTERPOLAR ward contact for each case"),
             colnames = c("ward", "calendar week", "F1 (patients)", "F1 (patients also in frontend)",
                          "F1 (encounters)", "F1 (encounters also in frontend)", "medication analyses",
                          "completed medication analyses", "MRP", "completed MRP documention",
                          "resolved MRP", "MRP resolution not informative", "contraindications",
                          "class: drug-drug", "class: drug-disease", "class: drug-renal insufficiency")
  )

  writeTableGlobal(frontend_summary,
             caption = paste0("Front-End Summary for period: ",REPORT_PERIOD_START, " to ", REPORT_PERIOD_END),
             footnote = c("Medication analysis and mrp counts: for all documented medication analysis of all INTERPOLAR ward contacts for each case"),
             colnames = c("ward", "patients", "encounters", "medication analyses",
                          "completed medication analyses", "MRP", "completed MRP documention",
                          "resolved MRP", "MRP resolution not informative", "contraindications",
                          "class: drug-drug", "class: drug-disease", "class: drug-renal insufficiency")
             )

  #TODO: implement pdf / quarto option ----------
}
